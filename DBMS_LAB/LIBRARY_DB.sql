/* 
LIBRARY_DB ........... question 1
*/

DROP DATABASE IF EXISTS LIBRARY_DB;
CREATE DATABASE LIBRARY_DB;
SHOW DATABASES;
USE LIBRARY_DB;

SHOW TABLES;
#programme start

/* creating tables */
CREATE TABLE PUBLISHER
(NAME VARCHAR(20) PRIMARY KEY,
ADDRESS VARCHAR(30),
PHONE INTEGER);
DESC PUBLISHER;

CREATE TABLE BOOK
(BOOK_ID INTEGER PRIMARY KEY,
TITLE VARCHAR(20),
PUBLISHER_NAME VARCHAR(20),
FOREIGN KEY(PUBLISHER_NAME) REFERENCES PUBLISHER(NAME) ON DELETE CASCADE,
PUB_YEAR VARCHAR(10));
DESC BOOK;

CREATE TABLE BOOK_AUTHORS
(BOOK_ID INTEGER,
AUTHOR_NAME VARCHAR(20),
FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE);
DESC BOOK_AUTHORS;

CREATE TABLE LIBRARY_BRANCH
(BRANCH_ID INTEGER PRIMARY KEY,
BRANCH_NAME VARCHAR(30),
ADDRESS VARCHAR(30));
DESC LIBRARY_BRANCH;

CREATE TABLE BOOK_COPIES
(BOOK_ID INTEGER,
BRANCH_ID INTEGER,
NO_OF_COPIES INTEGER,
FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
FOREIGN KEY(BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE,
PRIMARY KEY(BOOK_ID, BRANCH_ID));
DESC BOOK_COPIES;

CREATE TABLE BOOK_LENDING
(BOOK_ID INTEGER,
BRANCH_ID INTEGER,
CARD_NO INTEGER,
DATE_OUT DATE,
DUE_DATE DATE,
FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
FOREIGN KEY(BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE,
PRIMARY KEY(BOOK_ID, BRANCH_ID, CARD_NO));
DESC BOOK_LENDING;


/* insertion into tables */
INSERT INTO PUBLISHER VALUES
('MC-GRAWHILL', 'BANGALORE', 805450025),
('PEARSON', 'BANGALORE', 994523567),
('MARVELS', 'CHENNAI', 564589561),
('GRUPO PLANETTA', 'HYDERABAD', 894523567),
('RANDOM HOUSE', 'NEW DELHI', 230215004);
SELECT * FROM PUBLISHER;

INSERT INTO BOOK VALUES
(1, 'DBMS', 'MC-GRAWHILL', 'JAN-2017'),
(2, 'ADBMS', 'MC-GRAWHILL', 'JUN-2016'),
(3, 'CN', 'PEARSON', 'SEP-2016'),
(4, 'CG', 'GRUPO PLANETTA', 'SEP-2015'),
(5, 'OS', 'PEARSON', 'MAY-2017');
SELECT *FROM BOOK;

INSERT INTO BOOK_AUTHORS VALUES
(1, 'NAVATHE'),
(2, 'NAVATHE'),
(3, 'TANENBAUM'),
(4, 'EDWARD ANGEL'),
(5, 'GALVIN');
SELECT * FROM BOOK_AUTHORS;

INSERT INTO LIBRARY_BRANCH VALUES
(10, 'RR NAGAR', 'BANGALORE'),
(11, 'RNSIT', 'BANGALORE'),
(12, 'RAJAJI NAGAR', 'BANGALORE'),
(13, 'NITTE', 'MANGALORE'),
(14, 'MANIPAL', 'UDUPI');
SELECT * FROM LIBRARY_BRANCH;

INSERT INTO BOOK_COPIES VALUES
(1, 10, 10),
(1, 11, 5),
(2, 12, 2),
(2, 13, 5),
(3, 14, 7),
(4, 11, 3),
(5, 10, 1);
SELECT * FROM BOOK_COPIES;

INSERT INTO BOOK_LENDING VALUES
(1, 10, 101, '2017-01-01', '2017-06-01'),
(3, 14, 101, '2017-01-11', '2017-03-11'),
(2, 13, 101, '2017-02-21', '2017-04-21'),
(4, 11, 101, '2017-03-15', '2017-07-15'),
(1, 11, 104, '2017-04-12', '2017-05-12');
SELECT * FROM BOOK_LENDING;


/* QUERIES */
SELECT LB.BRANCH_ID, B.TITLE, B.PUBLISHER_NAME, BA.AUTHOR_NAME, BC.NO_OF_COPIES, B.BOOK_ID
FROM BOOK AS B, BOOK_AUTHORS BA, BOOK_COPIES BC, LIBRARY_BRANCH AS LB
WHERE B.BOOK_ID = BA.BOOK_ID
AND B.BOOK_ID = BC.BOOK_ID
AND LB.BRANCH_ID = BC.BRANCH_ID;


SELECT CARD_NO 
FROM BOOK_LENDING
WHERE DATE_OUT BETWEEN '2017-01-01' AND '2017-06-01'
GROUP BY CARD_NO
HAVING COUNT(*) > 3;

/*
DELETE FROM BOOK
WHERE PUB_YEAR LIKE '%2017%';
this will delete all books havinf pub_year 2017 followed by any month
*/
DELETE FROM BOOK
WHERE PUB_YEAR = 'JAN-2017';
SELECT * FROM BOOK;

CREATE VIEW V_PUB_YEAR
AS SELECT PUB_YEAR
FROM BOOK;
SELECT * FROM V_PUB_YEAR;

CREATE VIEW V_BOOKS
AS SELECT LB.BRANCH_ID, B.BOOK_ID, B.TITLE, BC.NO_OF_COPIES
FROM BOOK B, LIBRARY_BRANCH LB, BOOK_COPIES BC
WHERE B.BOOK_ID = BC.BOOK_ID
AND LB.BRANCH_ID = BC.BRANCH_ID;
SELECT * FROM V_BOOKS;
 









